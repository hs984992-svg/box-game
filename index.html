<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>صندوق المفاجآت - الإصدار الماسي</title>
    
    <script>
        window.onerror = function(msg, url, line) {
            alert("⚠️ تنبيه خطأ تقني:\n" + msg + "\nالسطر: " + line);
        };
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        :root { --bg-dark: #0a0a0a; }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-dark);
            color: #ffffff;
            margin: 0; overflow-x: hidden;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .bg-mesh {
            background-image: 
                radial-gradient(at 0% 0%, rgba(251, 191, 36, 0.08) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(139, 92, 246, 0.08) 0px, transparent 50%);
            background-attachment: fixed;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
    </style>
</head>
<body class="bg-mesh">
    
    <div id="root" class="min-h-screen flex flex-col items-center justify-center text-center p-4">
        <h1 class="text-3xl font-bold text-yellow-500 mb-4">جاري تجهيز الصناديق...</h1>
        <p class="text-gray-400">إذا طولت هذي الشاشة، تأكد من النت عندك.</p>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // --- نظام الأيقونات الداخلي ---
        const SVG = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const ICONS = {
            Gift: (p) => <SVG {...p}><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.9 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></SVG>,
            Package: (p) => <SVG {...p}><path d="M16.5 9.4 7.55 4.24"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/></SVG>,
            ShieldAlert: (p) => <SVG {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></SVG>,
            CheckCircle2: (p) => <SVG {...p}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></SVG>,
            XCircle: (p) => <SVG {...p}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></SVG>,
            Eye: (p) => <SVG {...p}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></SVG>,
            Flame: (p) => <SVG {...p}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></SVG>,
            Code: (p) => <SVG {...p}><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></SVG>,
            PlayCircle: (p) => <SVG {...p}><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></SVG>,
            Shield: (p) => <SVG {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></SVG>,
            Scan: (p) => <SVG {...p}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/></SVG>,
            Trophy: (p) => <SVG {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 1 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></SVG>
        };
        const Icon = ({ name, size = 24, className = "" }) => {
            const IconComp = ICONS[name];
            return IconComp ? <IconComp size={size} className={className} /> : null;
        };

        // --- إعدادات اللعبة ---
        const LEVELS_MAP = {
            easy: [ { id: 1, boxesCount: 2, safeCount: 1, gridCols: 'grid-cols-2' }, { id: 2, boxesCount: 3, safeCount: 2, gridCols: 'grid-cols-3' } ],
            medium: [ { id: 1, boxesCount: 2, safeCount: 1, gridCols: 'grid-cols-2' }, { id: 2, boxesCount: 4, safeCount: 2, gridCols: 'grid-cols-2' }, { id: 3, boxesCount: 6, safeCount: 2, gridCols: 'grid-cols-2 md:grid-cols-3' }, { id: 4, boxesCount: 9, safeCount: 3, gridCols: 'grid-cols-3' } ],
            hard: [ { id: 1, boxesCount: 3, safeCount: 1, gridCols: 'grid-cols-3' }, { id: 2, boxesCount: 6, safeCount: 2, gridCols: 'grid-cols-3' }, { id: 3, boxesCount: 9, safeCount: 2, gridCols: 'grid-cols-3' } ],
            insane: Array.from({ length: 10 }, (_, i) => ({ id: i + 1, boxesCount: Math.min(8 + i * 2, 30), safeCount: Math.max(1, Math.floor((8+i*2) * 0.2)), gridCols: 'grid-cols-4 md:grid-cols-6' }))
        };

        const GRAND_PRIZES = [
            { title: "حق الفيتو", description: "أنت تختار مكان الطلعة القادمة." },
            { title: "حصانة القطة", description: "قهوتك وعشاك اليوم مجاناً." },
            { title: "أمير القروب", description: "تغير اسم وصورة القروب ليوم كامل." },
            { title: "راعي الريموت", description: "تختار وش تتابعون اليوم." },
            { title: "إعفاء ملكي", description: "ما تصب قهوة ولا تخدم اليوم." }
        ];

        const Box = ({ index, isDead, isProceeding, isDefused, isXray, isSafe, isHint, disabled, onClick }) => {
            const statusClass = isDead ? 'bg-red-600 animate-shake shadow-red-500/50' : isProceeding ? 'bg-green-500 scale-95 shadow-green-500/50' : isDefused ? 'bg-gray-800 opacity-30 cursor-not-allowed' : isXray ? (isSafe ? 'bg-green-500/80 border-4 border-green-400' : 'bg-red-500/80 border-4 border-red-400') : isHint ? 'bg-red-900 border-4 border-red-500 animate-pulse' : disabled ? 'bg-gray-800 opacity-50' : 'bg-gradient-to-br from-purple-600 to-yellow-600 hover:scale-105 shadow-xl cursor-pointer';
            return (
                <button onClick={onClick} disabled={disabled || isDefused} className={`relative h-28 md:h-36 flex flex-col items-center justify-center rounded-2xl transition-all duration-300 transform shadow-lg ${statusClass}`}>
                    <div className="flex flex-col items-center gap-1">
                        {isDead ? <Icon name="ShieldAlert" size={40} /> : isProceeding ? <Icon name="CheckCircle2" size={40} /> : isDefused ? <Icon name="XCircle" size={40} className="text-gray-500" /> : isXray || isHint ? <Icon name="Eye" size={32} /> : <Icon name="Package" size={40} />}
                        <span className="font-black text-lg">{index + 1}</span>
                    </div>
                </button>
            );
        };

        function App() {
            const [gameState, setGameState] = useState('start');
            const [difficulty, setDifficulty] = useState('medium');
            const [currentLevelIdx, setCurrentLevelIdx] = useState(0);
            const [safeIndices, setSafeIndices] = useState([]);
            const [clickedIdx, setClickedIdx] = useState(null);
            const [winStreak, setWinStreak] = useState(0);
            const [reward, setReward] = useState(null);
            const [powerups, setPowerups] = useState({ defuse: true, shield: true, xray: true });
            const [isShieldActive, setIsShieldActive] = useState(false);
            const [defusedIndices, setDefusedIndices] = useState([]);
            const [xrayIdx, setXrayIdx] = useState(null);
            const [announcement, setAnnouncement] = useState("");

            const levels = LEVELS_MAP[difficulty];
            const currentLevel = levels[currentLevelIdx];

            const playSfx = (type) => {
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    const now = ctx.currentTime;
                    if (type === 'win') { osc.frequency.setValueAtTime(880, now); osc.frequency.exponentialRampToValueAtTime(1760, now + 0.1); gain.gain.setValueAtTime(0.1, now); osc.start(); osc.stop(now + 0.3); }
                    else if (type === 'lose') { osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(50, now + 0.3); gain.gain.setValueAtTime(0.1, now); osc.start(); osc.stop(now + 0.3); }
                    else { osc.frequency.setValueAtTime(600, now); gain.gain.setValueAtTime(0.05, now); osc.start(); osc.stop(now + 0.05); }
                } catch (e) {}
            };

            const initLevel = useCallback((idx) => {
                const level = levels[idx];
                const indices = Array.from({ length: level.boxesCount }, (_, i) => i);
                const shuffled = indices.sort(() => 0.5 - Math.random());
                setSafeIndices(shuffled.slice(0, level.safeCount));
                setClickedIdx(null); setDefusedIndices([]); setXrayIdx(null);
                setAnnouncement(`المستوى ${idx + 1}`);
            }, [levels]);

            useEffect(() => { if (gameState === 'playing') initLevel(currentLevelIdx); }, [gameState, currentLevelIdx, initLevel]);

            const handleBoxClick = (idx) => {
                if (clickedIdx !== null || gameState !== 'playing') return;
                setClickedIdx(idx);
                if (safeIndices.includes(idx)) {
                    playSfx('win');
                    if (currentLevelIdx < levels.length - 1) setTimeout(() => setCurrentLevelIdx(p => p + 1), 800);
                    else {
                        const p = GRAND_PRIZES[Math.floor(Math.random() * GRAND_PRIZES.length)];
                        setReward(p); setWinStreak(p => p + 1); setTimeout(() => setGameState('finished'), 800);
                    }
                } else {
                    if (isShieldActive) { setIsShieldActive(false); setClickedIdx(null); setAnnouncement("الدرع حماك!"); }
                    else { playSfx('lose'); setWinStreak(0); setTimeout(() => setGameState('lost'), 800); }
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4">
                    <div className="sr-only" aria-live="polite">{announcement}</div>
                    
                    {/* UI للهيدر */}
                    {winStreak > 0 && <div className="fixed top-4 right-4 bg-orange-500 text-black px-3 py-1 rounded-full font-bold z-50 animate-bounce">{winStreak} فوز</div>}
                    <div className="fixed bottom-4 left-4 bg-white/10 px-4 py-2 rounded-full backdrop-blur-md z-50 border border-white/10"><span className="text-xs text-gray-400 block">المطور</span><span className="font-bold text-sm">حسن سهلي</span></div>

                    {gameState === 'start' && (
                        <div className="glass-card w-full max-w-md p-8 rounded-[2rem] text-center animate-in fade-in zoom-in">
                            <div className="bg-yellow-400 w-16 h-16 rounded-2xl mx-auto mb-6 flex items-center justify-center text-black rotate-12 shadow-lg"><Icon name="Gift" size={32}/></div>
                            <h1 className="text-4xl font-black mb-2 text-white">صندوق المفاجآت</h1>
                            <p className="text-gray-400 mb-8">اختر الصعوبة وابدأ</p>
                            <div className="grid grid-cols-2 gap-2 mb-8">
                                {['easy', 'medium', 'hard', 'insane'].map(d => (
                                    <button key={d} onClick={() => setDifficulty(d)} className={`p-3 rounded-xl border ${difficulty === d ? 'border-yellow-400 bg-yellow-400/10' : 'border-white/10 bg-white/5'}`}>{d === 'easy' ? 'سهل' : d === 'medium' ? 'وسط' : d === 'hard' ? 'صعب' : 'جنوني'}</button>
                                ))}
                            </div>
                            <button onClick={() => { playSfx('click'); setGameState('playing'); setCurrentLevelIdx(0); setPowerups({defuse:true, shield:true, xray:true}); setIsShieldActive(false); }} className="w-full py-4 bg-white text-black font-black text-xl rounded-xl hover:bg-yellow-400 transition-colors">ابدأ اللعبة</button>
                        </div>
                    )}

                    {gameState === 'playing' && (
                        <div className="w-full max-w-3xl animate-in fade-in">
                            <div className="flex justify-between items-center mb-6 px-2">
                                <div><span className="text-xs text-gray-500 font-bold block">مرحلة</span><span className="text-2xl font-black">{currentLevelIdx + 1}</span></div>
                                <div className="flex gap-2">
                                    <button onClick={() => {if(powerups.defuse){setPowerups(p=>({...p,defuse:false})); const m=Array.from({length:currentLevel.boxesCount},(_,i)=>i).filter(i=>!safeIndices.includes(i)); setDefusedIndices(m.sort(()=>0.5-Math.random()).slice(0,Math.ceil(m.length/2)));}}} disabled={!powerups.defuse} className={`p-3 rounded-xl border ${powerups.defuse ? 'border-cyan-500 text-cyan-400' : 'opacity-20'}`}><Icon name="Scan"/></button>
                                    <button onClick={() => {if(powerups.shield && !isShieldActive){setPowerups(p=>({...p,shield:false})); setIsShieldActive(true);}}} disabled={!powerups.shield || isShieldActive} className={`p-3 rounded-xl border ${isShieldActive ? 'bg-green-500 text-black' : powerups.shield ? 'border-yellow-500 text-yellow-400' : 'opacity-20'}`}><Icon name="Shield"/></button>
                                    <button onClick={() => {if(powerups.xray){setPowerups(p=>({...p,xray:false})); setXrayIdx(Math.floor(Math.random()*currentLevel.boxesCount)); setTimeout(()=>setXrayIdx(null),2000);}}} disabled={!powerups.xray} className={`p-3 rounded-xl border ${powerups.xray ? 'border-orange-500 text-orange-400' : 'opacity-20'}`}><Icon name="Eye"/></button>
                                </div>
                            </div>
                            <div className={`grid gap-3 ${currentLevel.gridCols}`}>
                                {Array.from({ length: currentLevel.boxesCount }).map((_, i) => (
                                    <Box key={i} index={i} isSafe={safeIndices.includes(i)} isDead={clickedIdx === i && !safeIndices.includes(i)} isProceeding={clickedIdx === i && safeIndices.includes(i)} isDefused={defusedIndices.includes(i)} isXray={xrayIdx === i} disabled={clickedIdx !== null} onClick={() => handleBoxClick(i)} />
                                ))}
                            </div>
                        </div>
                    )}

                    {(gameState === 'lost' || gameState === 'finished') && (
                        <div className="glass-card p-10 rounded-[2.5rem] text-center animate-in zoom-in border border-white/10 max-w-md w-full">
                            <div className={`w-20 h-20 rounded-full mx-auto mb-6 flex items-center justify-center text-white text-3xl shadow-xl ${gameState === 'lost' ? 'bg-red-600' : 'bg-yellow-400 text-black'}`}>
                                <Icon name={gameState === 'lost' ? 'ShieldAlert' : 'Trophy'} size={40}/>
                            </div>
                            <h2 className="text-4xl font-black mb-4">{gameState === 'lost' ? 'انفجار!' : 'مبروك!'}</h2>
                            {gameState === 'finished' && reward && <div className="bg-white/5 p-4 rounded-xl mb-6"><p className="text-xl font-bold text-yellow-400">{reward.title}</p><p className="text-sm text-gray-400">{reward.description}</p></div>}
                            <button onClick={() => setGameState('start')} className="w-full py-4 bg-white text-black font-black rounded-xl hover:scale-105 transition-transform">القائمة الرئيسية</button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
